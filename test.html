<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.17.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@4.17.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body onload="runUpdateCount(); do_it();">

<div id="vis"></div>

<br>

<p style="color: gray;">Unfinished calculation count: <a style="color: black;" id="unfinished_count">?</div></p>

<script type="text/javascript">
  const baseUrl = 'http://34.117.135.4';
  var limit = 10;
  // grab limit from fragment
  if(window.location.hash) { // does the URL contain a fragment?
    const fragment = window.location.hash.substring(1); // remove leading '#'
    const parsedLimit = parseInt(fragment);
    if (!isNaN(parsedLimit)) {
      limit = parsedLimit;
      console.log("Limit: " + parsedLimit);
    }
  }
  let dataUrl = baseUrl + '/liquidity/all?slippage=0.5&numeraire=USD&limit=' + limit;

  function uniq(a) {
      return a.sort().filter(function(item, pos, ary) {
          return !pos || item != ary[pos - 1];
      });
  }

  // source: https://stackoverflow.com/a/2901298/700597
  function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  async function runUpdateCount() {
    let unfinishedCount = document.getElementById('unfinished_count');
    async function updateCounter() {
      const resp = await fetch(baseUrl + '/calc/unfinished/count');
      const data = await resp.json();
      unfinishedCount.innerHTML = numberWithCommas(data);
    }
    updateCounter();
    return setInterval(updateCounter, 5000);
  }

  async function do_it() {
    const uniqueCurrencies = objList =>
      uniq( objList.map(x => x.currency) );
    const mkTooltipOptions = objList =>
      uniqueCurrencies(objList).map(x => ({"field": x, "type": "quantitative"}));

    let response = await fetch(dataUrl);
    let data = await response.json();

    const tooltipOptions = mkTooltipOptions(data);

    var spec =
    {
      "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
      "data": {
        "url": dataUrl,
      },
      "format": {
          "parse": {
            "run.time_start": "date",
            "qty": "number",
            "currency": "string",
            "run.id": "number"
          }
        },
      "width": 600,
      "height": 450,
      "transform": [
        {"filter": "datum.qty > 1000"},
        {"calculate": "1e-6 * datum.qty", "as": "qty_mm"},
      ],
      "encoding": {
        "x": {
          "field": "run.time_start",
          "type": "temporal",
          "title": "Time"
        },
        "tooltip": [
          {"field": "currency", "title": "Currency", "type": "nominal"},
          {"field": "qty_mm", "title": "Quantity (MM USD)", "type": "quantitative"},
          {"field": "run.time_start", "title": "Time", "type": "temporal"},
          {"field": "run.id", "title": "Run ID", "type": "nominal"}
        ]
      },
      "layer": [
        {
          "encoding": {
            "color": {"field": "currency", "type": "nominal", "title": "Currency"},
            "y": {
              "field": "qty_mm",
              "type": "quantitative",
              "title": "Quantity (MM USD)",
              "scale": {"type": "log"},
            }
          },
          "layer": [
            {"mark": "line"},
            {"mark": "point"},
            {"transform": [{"filter": {"selection": "hover"}}], "mark": "point"}
          ]
        },
        {
          "transform": [{"pivot": "currency", "value": "qty_mm", "groupby": ["run.time_start"]}],
          "mark": "rule",
          "encoding": {
            "opacity": {
              "condition": {"value": 0.3, "selection": "hover"},
              "value": 0
            },
            "tooltip": tooltipOptions
          },
          "selection": {
            "hover": {
              "type": "single",
              "fields": ["run.time_start"],
              "nearest": true,
              "on": "mouseover",
              "empty": "none",
              "clear": "mouseout"
            }
          }
        }
      ]
    }

    vegaEmbed('#vis', spec).then(function(result) {
      // Access the Vega view instance (https://vega.github.io/vega/docs/api/view/) as result.view
    }).catch(console.error);
  }
</script>
</body>
</html>
